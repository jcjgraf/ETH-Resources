%! TEX root = ./main.tex

\section{Network Layer}
\subsection{General}
\begin{itemize}
    \item Builds on link layer and provides service to transport layer
    \item Transports packets
    \item Challenges
        \begin{itemize}
            \item Scale to a global internet
            \item Heterogeneity
            \item Bandwidth control
            \item Economics
        \end{itemize}
    \ides{Routing:} Figure out which path to take
    \ides{Forwarding:} Send packet on its way
    \ides{Network Service Models}
        \begin{itemize}
            \item Describes what service does it provide to the transport layer
            \ides{Store-And-Forward Packet Switching:}
                \begin{itemize}
                    \item Both are implemented with store-and-forward packet switching
                    \item Routers receive packages, and store it (if necessary) in a FIFO quere before forwarding it
                        \begin{itemize}
                            \item Have a buffer per port (slightly simplified view)
                        \end{itemize}
                \end{itemize}
            \item Provide two different service models
            \ides{Datagrams (/Connection Less Service)}
                \begin{itemize}
                    \item Packets contain a destination address
                    \item Destination address is used to forward each packet from router to router
                        \begin{itemize}
                            \item Possible over different paths
                        \end{itemize}
                    \item Like postal letters
                    \item Prime type used today
                    \item Used for IP protocol
                    \ides{Forwarding Table:}
                        \begin{itemize}
                            \item Used by each router
                            \item Keyed by address
                            \item Gives next hop for each destination address
                            \item Is dynamic
                                \begin{itemize}
                                    \item Changes when new links are created and old are removed
                                \end{itemize}
                        \end{itemize}
                \end{itemize}
            \ides{Virtual Circuits (Connection-Oriented Service)}
                \begin{itemize}
                    \item Uses circuit switching (in a virtual sense)
                        \begin{itemize}
                            \item There is no bandwidth reservation
                            \item But statistical sharing of link
                        \end{itemize}
                    \item Like a telephone call
                    \item Three phases
                        \begin{itemize}
                            \item Connection establishment
                                \begin{itemize}
                                    \item Circuit is set up
                                    \item Path is chosen
                                \end{itemize}
                            \item Data transfer
                                \begin{itemize}
                                    \item Circuit is used
                                    \item Packets are forwarded
                                \end{itemize}
                            \item Connection teardown
                                \begin{itemize}
                                    \item Circuit is deleted
                                    \item Circuit information is removed from all routers
                                \end{itemize}
                        \end{itemize}
                    \item Each packet has a shorter label
                        \begin{itemize}
                            \item Used to identify the circuit and not destination
                        \end{itemize}
                    \ides{Forwarding Table}
                        \begin{itemize}
                            \item Used by each router
                            \item Keyed by the circuit identifier
                                \begin{itemize}
                                    \item Last router name, and label
                                \end{itemize}
                            \item Gives next router name and new packet label
                        \end{itemize}
                    \ides{Multi-Protocol Label Switching (MPLS)}
                        \begin{itemize}
                            \item Virtual-Circuit like
                            \item Used by many ISPs in their backbone
                            \item Adds MPLS fields upon entering their network
                            \item Removed MPLS field upon leaving their network
                            \item Takes up some digits of the IP
                            \ipro Allows forwarding on routes not possible using standard IP protocol
                            \ipro Potential increased switching speed
                                \begin{itemize}
                                    \item No longest-prefix matching required
                                \end{itemize}
                            \icon Dated
                            \icon Unflexible
                            \icon Hard to setup
                        \end{itemize}
                \end{itemize}
            \item Datagrams vs Virtual Circuits
                \begin{itemize}
                    \item
                    \begin{tabular}{| l | l | l |}
                        Setup phase & \textbf{Not needed} & Required\\
                        Router State & \textbf{Per destination} & Per connection\\
                        Addresses & Packet carries full address & \textbf{Packet carries short label}\\
                        Routing & Per packet & \textbf{Per circuit}\\
                        Failures & \textbf{Easier to mask} & Difficult to mask\\
                        Quality of Service & Difficult to add & \textbf{Easier to add}\\
                    \end{tabular}
                \end{itemize}
        \end{itemize}
    \ides{Internetworking}
        \begin{itemize}
            \item Connection different networks together
            \item Networks are different in:
                \begin{itemize}
                    \item Service model
                    \item Addressing
                    \item QoS
                    \item Packet size
                    \item Security
                \end{itemize}
            \item Hides the differences with a common protocol
            \ides{Internet Protocol (IP):}
                \begin{itemize}
                    \item Lowest common denominator
                    \item Asks for little
                    \item Provides little
                \end{itemize}
        \end{itemize}
\end{itemize}

\subsection{IPv4}
\begin{itemize}
    \ides{IP Datagram}
        \begin{itemize}
            \item Each row is $32$ bits
            \ides{Version:} $4$ or $6$
            \ides{IHL (Internet Header Length):} Length of header
            \ides{Type of Service:} distinguish different types of datagrams
                \begin{itemize}
                    \item real-time, non-real time etc.
                    \item For QoS
                \end{itemize}
            \ides{Datagram length (bytes):} total length of datagram in bytes
                \begin{itemize}
                    \item At most $2^{16}$
                \end{itemize}
                \ides{Identification:} \todo{What is identification for?}
            \ides{Flags:} Used for fragmentation
            \ides{Fragment Offset:} Used for fragmentation
            \ides{TTL:} Maximal desired number of hops
                \begin{itemize}
                    \item Decreased by one at every hop
                \end{itemize}
            \ides{Protocol:} TCP or UDP
                \begin{itemize}
                    \item Only considered at final destination
                \end{itemize}
            \ides{Header Checksum:} Checksum over header
            \ides{Source Address:} $32$ bit source
            \ides{Destination Address:} $32$ bit destination
            \ides{Options:} Optional fields to set
        \end{itemize}
    \ides{IP Addresses and Prefixes}
        \begin{itemize}
            \item $32$ bits long
            \ides{Dotted Nottation:} Split into four parts of $8$ bits length
                \begin{itemize}
                    \item $a.b.c.d$
                \end{itemize}
            \ides{Prefixes:} Addresses are allocated in blocks
                \begin{itemize}
                    \item Blocks are called prefixes
                    \item All addresses in the same $L$-bit prefix have the same top $L$ bits
                    \item There are $2^{32 - L}$ addresses in an $L$-bit block
                    \item The remaining represents the hosts on the network
                    \item Written as \verb+IP Address / Prefix Length+
                        \begin{itemize}
                            \item IP address is the first address in the block
                        \end{itemize}
                    \ides{More specific:} longer prefix
                    \ides{Less Specific:} shorter prefix
                    \item Fist and last address in of prefix cannot be used
                        \begin{itemize}
                            \ides{Network Identifier:} first address in prefix
                                \begin{itemize}
                                    \item Hosts bits are all zero
                                \end{itemize}
                            \ides{Broadcast Address:} last address in prefix
                                \begin{itemize}
                                    \item Host bits are all one
                                \end{itemize}
                        \end{itemize}
                    \ides{Network Mask:} Together with the address give the prefix
                        \begin{itemize}
                            \item Bitwise and of mask and address give prefix/network identifier
                                \begin{itemize}
                                    \item Network bits are one
                                    \item Host bits are zero
                                \end{itemize}
                        \end{itemize}
                \end{itemize}
                \ides{Public Addresses}
                    \begin{itemize}
                        \item Assigned by IANA to different RIRs (regional internet registries)
                        \item RIRs issue ranges to ISP
                        \item ISP issue to customers
                        \item Buy IP4 is difficult
                            \begin{itemize}
                                \item Rund out of addresses
                                \item Expensive
                                \item May have been be misused before
                                \item Geolocation
                            \end{itemize}
                    \end{itemize}
                \ides{Private Addresses}
                    \begin{itemize}
                        \item Only valid within a private network
                        \item Three prefixes are available
                            \begin{itemize}
                                \item $10.0.0.0/8$
                                \item $172.16.0.0/12$
                                \item $192.168.0.0/16$
                            \end{itemize}
                        \item Need public IP and NAT to connect to global internet
                    \end{itemize}
        \end{itemize}
    \ides{IP Forwarding}
        \begin{itemize}
            \item All IP addresses on one network have the same prefix
            \item Next hop is determined using forwarding table
                \begin{itemize}
                    \item Indexed using IP prefix
                    \item Prefixes may overlap
                \end{itemize}
            \ides{Longest Matching Prefix Forwarding Rule:}
                \begin{itemize}
                    \item Algorithm
                        \begin{itemize}
                            \item For each packet find all matching prefixes
                            \item Find the longest prefix from that set
                            \item Forward the packet to the next hop router for that prefix
                        \end{itemize}
                    \ides{Compress Forwarding Table:} Remove redundant forwarding rules
                        \begin{itemize}
                            \item I.e. rules which are overwritten by more specific ones
                        \end{itemize}
                    \item Can provide default behaviour
                        \begin{itemize}
                            \item With less specific prefixes
                        \end{itemize}
                    \item Can provide special behaviour
                        \begin{itemize}
                            \item With more specific prefixes
                        \end{itemize}
                    \item Hierarchical addresses allow compact tables
                    \item Find longest matching prefix is more complex than table lookup
                \end{itemize}
            \icon Size of forwarding tables is keep growing
            \ides{Host Forwarding}
                \begin{itemize}
                    \item Host has a lookup table with two entries:
                        \begin{itemize}
                            \ides{Network Prefix:} Send all traffic directly to the host
                            \ides{Default Route:} $0.0.0.0/0$
                                \begin{itemize}
                                    \item Matches all addresses
                                    \item Any more specific address is captured first
                                \end{itemize}
                        \end{itemize}
                \end{itemize}
            \item At each forward, the router must
                \begin{itemize}
                    \item Decrement TTL
                    \item Check and recalculate header checksum
                    \item Fragment larger packets if link network MTU is limited
                    \item Send congestion signals
                    \item Generate error messages
                    \item Handle options specified in the IP header
                \end{itemize}
        \end{itemize}
\end{itemize}

\subsection{IP Helper Protocols}
\begin{itemize}
    \item IP \textbf{requires} help from other protocols
    \item There area many of then
    \item Often involve broadcast
    \ides{Dynamic Host Configuration Protocol (DHCP)}
        \begin{itemize}
            \item How does a host get
                \begin{itemize}
                    \item Its IP address
                    \item Routers IP address
                    \item Network prefix
                    \ides{Default gateway}: Local router address
                    \item DNS Server
                    \item etc.
                \end{itemize}
            \item On connection, only the link MAC address is known
            \item Introduces in 1993
            \item Is a client - server application
            \item Part of the network (router)
            \item Uses UDP on port 67, 68
            \item Steps
                \begin{itemize}
                    \ides{Broadcast Message:} Client sends \verb+DISCOVER+ message to broadcast address
                        \begin{itemize}
                            \item Message is received by all hosts on network
                            \item \verb+255.255.255.255+ for IP and \verb+ff:ff:ff:ff:ff:ff+ for MAC \todo{Why needed?}
                        \end{itemize}
                     \item DHCP server send \verb+OFFER+ and offers certain options
                     \item Client send \verb+REQUEST+ to accept an offer
                     \item Server sends \verb+ACK+ an leases IP to client
                \end{itemize}
            \item Renewing lease only requires \verb+REQUEST+ followed by \verb+ACK+
            \icon Does not provide any security
                \begin{itemize}
                    \item Malicious host can act as a DHCP server
                \end{itemize}
        \end{itemize}
    \ides{Address Resolution Protocol (ARP)}
        \begin{itemize}
            \item Node needs link layer address to send frame but only has destination IP address
            \item Sits on the link layer
            \item Only works if node and target are on the same link
                \todo{What does that mean?}
            \item Steps
                \begin{itemize}
                    \item Nodes sends a \verb+REQUEST+ broadcast message with an IP address
                    \item Target sees broadcast and notices its IP address
                    \item Target sends \verb+REPLY+ containing its MAC address
                    \item Note caches the MAC address in its ARP cache
                \end{itemize}
            \item Asks nodes addressed with their IP address to identify themselves
        \end{itemize}
\end{itemize}

\subsection{Packet Size}
\begin{itemize}
    \ides{Maximum Transmission Unit (MTU)}
        \begin{itemize}
            \item Maximal allowed packet size
        \end{itemize}
    \item Different networks have different MTUs
    \item Goal: send packets as large as possible
        \begin{itemize}
            \item Less header overhead
            \item Fever packets required
        \end{itemize}
    \icon Hard to figure out appropriate size to send packets
    \item Two methods to solve this problem
        \begin{itemize}
            \ides{Fragmentation}
                \begin{itemize}
                    \item If a packet is too large for e given link, the router splits the packet into multiple smaller ones
                        \begin{itemize}
                            \item Break data into pieces
                            \item Copy main IP header into header of pieces
                            \item Adjust the \verb+length+ in the header
                            \item Set \verb+fragment offset+ in the header to indicate the position in the packet
                            \item Set \verb+MF+ (more fragments) \verb+flags+ in IP header on all pieces except the last
                                \begin{itemize}
                                    \item If set it means a fragment is following the current one
                                \end{itemize}
                        \end{itemize}
                    \item Receiver reassembles the fragmented packets
                        \begin{itemize}
                            \item \verb+Identification+ links pieces together
                            \item \verb+MF+ tells than all pieces are together
                        \end{itemize}
                    \icon Repeated fragmentation is possible $\implies$ messy
                    \icon Fragmentation is undesirable
                        \begin{itemize}
                            \icon More work for routers
                            \icon Fragment loss $\implies$ packet loss $\implies$ retransmission of whole packet
                            \icon Security vulnerability
                        \end{itemize}
                    \item Not used today anymore
                \end{itemize}
            \ides{Path MTU Discovery}
                \begin{itemize}
                    \item Host sends largest packets
                        \begin{itemize}
                            \item \verb+DF+ flag (do not fragment) set
                            \item Hosts use heuristisch on which MTUs to try
                                \begin{itemize}
                                    \item There are protocols in practice but they are not used
                                \end{itemize}
                        \end{itemize}
                    \item Routers send ICMP and tell their max largest size in case the original packet was too large
                    \item Hosts adjusts packet size to fit the MTU of the path
                    \icon Path may change and break the transmission
                    \ipro Avoids fragmentation
                    \item Used today
                \end{itemize}
        \end{itemize}
\end{itemize}

\subsection{Internet Control Message Protocol (ICMP)}
\begin{itemize}
    \item Sits on top of IP
    \item Is carried in an IP packet
    \item Used for:
        \begin{itemize}
            \ides{Error:} Router sends ICMP when it encounters an error during forwarding
            \ides{Testing:} \todo{Not sure what can be tested}
        \end{itemize}
    \ides{Format}
        \begin{itemize}
            \item Header contains type, code and checksum
            \item Payload is often the problematic IP packet
                \begin{itemize}
                    \item For the host to identify the problem
                \end{itemize}
            \item Types:
                \begin{itemize}
                    \item
\begin{tabular}{| l | l | l}
    Dest. Unreachable & 3/0 or 1 & Lack of connectivity\\
    Dest. Unreachable & 3/4 & Path MTU Discovery\\
    Time Exceeded (Transit) & 11/0 & Traceroute\\
    Echo Request or Reply & 8 or 0/0 & Ping
\end{tabular}
                \end{itemize}
        \end{itemize}
    \ides{Traceroute:}
        \begin{itemize}
            \item Allows host to find every router hop
            \item Sends probe packets with increasing TTL
                \begin{itemize}
                    \item Start with $1$ and increase to $N$
                \end{itemize}
            \item When TTL is $0$ for a router, it reports that using ICMP
                \begin{itemize}
                    \item We can identify the router
                \end{itemize}
            \icon Routers can identify probe and behave differently
        \end{itemize}
    \icon Has not security measurements
\end{itemize}

\subsection{Network Address Translation (NAT)}
\begin{itemize}
    \item Routers are supposed at only IP headero
    \ides{Middlebox:} Device which should not but looks at transmission protocol too
        \begin{itemize}
            \item Allows for new functionality
                \begin{itemize}
                    \item NAT Box
                    \item Firewall
                    \item Intrusion detection
                \end{itemize}
                \ipro Possible rapid deployment path when there is not other option \todo{What does it mean?}
            \ipro Control over many hosts
            \icon Break end-to-end connectivity
                \begin{itemize}
                    \item Strange side-effects
                \end{itemize}
            \icon Poor vantage point for many tasks
            \icon Cause internet ossification
                \begin{itemize}
                    \item Almost impossible to deploy new transport protocols
                \end{itemize}
        \end{itemize}
    \ides{NAT Box}
        \begin{itemize}
            \item Done by a middlebox
            \item Connects an internal network to an external network
                \begin{itemize}
                    \item Does multiplexing
                        \begin{itemize}
                            \item Many local hosts - single external IP
                        \end{itemize}
                \end{itemize}
            \item Translates addresses and ports
        \end{itemize}
    \ides{How NAT works}
        \begin{itemize}
            \item Keeps a internal/external table
                \begin{itemize}
                    \item Contains internal to external IP and Port mapping
                        \begin{itemize}
                            \item Port mapping is required that incoming packet get to the right host (in case there are multiple hosts with the same port)
                        \end{itemize}
                \end{itemize}
            \ides{Internal $\mathbf{\to}$ external:} When an internal hosts establishes a TCP connection to the outside
                \begin{itemize}
                    \item Lookup in table
                    \item Create new entry if none exists
                    \item Rewrite source IP/Port of IP header
                \end{itemize}
            \ides{External $\mathbf{\to}$ internal:}
                \begin{itemize}
                    \item Lookup in table
                    \item Rewrite address and port
                    \item If no entry in table the connection is blocked
                        \begin{itemize}
                            \item Need to configure entry manually
                        \end{itemize}
                \end{itemize}
        \end{itemize}
    \icon Connectivity broken
        \begin{itemize}
            \item Only works for initial outgoing traffix
        \end{itemize}
    \icon Problematic with UDP
        \begin{itemize}
            \item Since there is no connection \todo{How is this solved?}
        \end{itemize}
    \ipro Multiplexing
    \ipro Flexible in address space
    \ipro Useful functionality
        \begin{itemize}
            \item Firewall
            \item Privacy (hides network structure)
        \end{itemize}
\end{itemize}

\subsection{IPv6}
\begin{itemize}
    \item Replacement for IPv4
    \item IPv4 address space is exhausted
    \item Proposed in 1994
    \item $128$ bits addresses
    \item Denoted in $8$ groups of $4$ hex digits ($16$ bits)
    \item Omit leading zeros within each group
    \item Omit one connective group of all zeros
        \begin{itemize}
            \item Else original address cannot be reconstructed
        \end{itemize}
    \icon Not backwards compatible
        \begin{itemize}
            \item Specific routers required
        \end{itemize}
    \item Header
        \begin{itemize}
            \item Simpler
            \item $32$ bits per line
                \ides{Version:} 6
                \ides{Traffic Class:} Former type of service
                \ides{Flow label:} Allow router to identify a flow
                \begin{itemize}
                    \item Packets of same flow stay together (same path)
                \end{itemize}
                \ides{Payload Length:} Former total length
                \ides{Next hdr (header):} Former protocol
                \ides{Hop Limit:} Old TTL
                \ides{Source Address:} $128$ bits
                \ides{Destination Address:} $128$ bits
            \ides{Flow:} Allows router to identify a flow
            \ides{Payload Length:} Former total length
            \item Removed
                \begin{itemize}
                    \ides{IHL:}
                        \begin{itemize}
                            \ides{Streamlined Header Processing:} No option fields
                                \begin{itemize}
                                    \item Header has fixed $40$ bytes size
                                    \item Allows for faster processing
                                \end{itemize}
                        \end{itemize}
                    \item Fragmentation related fields were removed
                        \begin{itemize}
                            \item Host must ensure that MTU is not exceeded
                        \end{itemize}
                    \item Header checksum is removed
                        \begin{itemize}
                            \item Rely on transport layer checksum
                        \end{itemize}
                \end{itemize}
        \end{itemize}
    \item Hierarchical organisation
        \begin{itemize}
            \ides{Routing Prefix:} First $\ge 48$ bit
                \begin{itemize}
                    \item Identifies ISP
                \end{itemize}
            \ides{Subnet ID:} Middle $\le 16$ bits
                \begin{itemize}
                    \item Subnet or ISP customer
                \end{itemize}
            \ides{Interface identifier:} Last $64$ bits
                \begin{itemize}
                    \item Can be based on MAC address
                \end{itemize}
        \end{itemize}
    \item Address types
        \begin{itemize}
            \item A single host can have multiple addresses for the same interface \todo{What for?}
            \item Local link address \verb+fe80::/10+
                \begin{itemize}
                    \item Every hosts has it
                    \item Automatically setup
                    \item Based on MAC address
                \end{itemize}
            \ides{Global Unique Address (GUA):} currently \verb+2000::/3+
                \begin{itemize}
                    \item globally reachable
                    \item The \textit{normal} IPv6 address
                \end{itemize}
            \ides{Unique Local Address (ULA):} \verb+fc00::/7+
                \begin{itemize}
                    \item For local deployments
                    \item Can be NATed to GUA
                \end{itemize}
            \ides{Loopback Address:} \verb+::1/128+
            \ides{Unspecified Address:} \verb+::0/128+
            \item etc.
        \end{itemize}
    \ides{Neighbor Discovery Protocol (NDP):}
        \begin{itemize}
            \item Provides ARP and DHCP functionality
            \item Hosts can be configured through stateless address autoconfiguration (SLAAC) bases on NDP
                \begin{itemize}
                    \item Hosts automatically set their link-local address
                    \item \textit{Router solicitation} and \textit{router advertisement} provide DHCP-like functionality
                    \item Host perform \textit{duplicate address detection} based on \textit{neighbor solicitation} and \textit{neighbor advertisement}
                    \item \textit{Neighbor solicitation} and \textit{neighbor advertisement} replace ARP
                \end{itemize}
            \todo{Not sure what this all means}
        \end{itemize}
    \item NAT is possible but not needed
    \item Many routers still block incoming traffic
        \begin{itemize}
            \item Manual configuration necessary
        \end{itemize}
    \item Transition
        \begin{itemize}
            \item Many approaches proposed
                \ides{Multiple stacks:} Router can talk both
                \ides{Translators:} Map between both addresses
                \ides{Tunnels:} Encapsulate packet in an other (IPv6 over IPv4, IPv4 over IPv6 etc.)
                    \begin{itemize}
                        \item Hard to know where to start and end a tunnel
                    \end{itemize}
                \ides{Happy Eyeballs:} Favour IPv6 over IPv4
                \begin{itemize}
                    \item Should dual-stack hosts use IPv4 or IPv6?
                    \item Issue A (IPv4) and AAAA (IPv6) DNS query simultaneously
                    \item If AAAA is received, use IPv6 immediately
                    \item If A is received, wait for some milliseconds for AAAA
                        \begin{itemize}
                            \item A is often faster since it is cached
                        \end{itemize}
                    \item If first connection attempt to IPv6 (or IPv4) is unsuccessful try with IPv4 (or IPv6)
                \end{itemize}
        \end{itemize}
\end{itemize}

\todo{Possibly split into data and control plane}

\subsection{Routing}
\begin{itemize}
    \item Allocates network bandwidth
    \item Needs to adapting to failures
    \item A Quick comparison of different mechanisms
        \begin{itemize}
            \item
\begin{tabular}{| l | l | l}
    Mechanism & Timescale & Adaption\\\hline
    Load-sensitive routing & Seconds & Traffic hotspots\\
    Routing & Minutes & Equipment failures\\
    Traffic Engineering & Hours & Network load\\
    Network Provisioning & Months & Network customers
\end{tabular}
        \end{itemize}
    \item Delivery models
        \begin{itemize}
            \ides{Unicast:} One to one
            \ides{Broadcast:} One to many (all)
            \ides{Multicast:} One to few (not all)
            \ides{Anycast:} Many to many
                \begin{itemize}
                    \item One source always to one destination
                \end{itemize}
        \end{itemize}
    \item Goals of routing protocols
        \begin{itemize}
            \ides{Correctness:} Find paths that work
            \ides{Efficient paths:} Given path is minimal for some metric
            \ides{Fair paths:} Does not starve any nodes
            \ides{Fast convergence:} Recovers quickly after changes
            \ides{Scalability:} Works well as networks grows large
        \end{itemize}
    \item Setting is decentralized and distributed:
        \begin{itemize}
            \item All nodes are alike
                \begin{itemize}
                    \item No controller
                \end{itemize}
            \item Nodes only know what they learn by exchanging messages with neighbours
            \item Nodes operate concurrently
            \item Maybe node/link/message failures
        \end{itemize}
    \item Apply different methods for different parts/typologies of the network
\end{itemize}

\subsubsection{Network Typologies}
\begin{itemize}
    \ides{Initial Idea:} Each computer is directly accessible via its own IP
        \begin{itemize}
            \icon Not scalable as internet grows
        \end{itemize}
    \item Multiple techniques to scale routing
    \ides{IP Prefix}
        \begin{itemize}
            \ides{Idea:} Bundle a bunch of devices together
            \item Hosts attach to routers as IP prefixes
                \begin{itemize}
                    \item Multiple hosts are grouped in one prefix
                \end{itemize}
            \item Router advertises prefixes for hosts
            \item Router addresses are in the $/32$ prefix
                \begin{itemize}
                    \item They are the only node to contact since they forward the traffic
                \end{itemize}
        \end{itemize}
    \ides{Hierarchical Routing}
        \begin{itemize}
            \ides{Idea:} Route to region before routing to more specific prefix
            \item Builds on top of IP prefixes by bundling many prefixes
            \item Outside a regions, a single nodes has only one paths to all hosts within a different region
                \begin{itemize}
                    \ipro Reduces forwarding table size as it hides region-internal structure
                \end{itemize}
            \item Different nodes of one region may use different paths to a certain region
            \icon May lead to longer paths
        \end{itemize}
    \ides{IP Prefix Aggregation (and Subnets)}
        \begin{itemize}
            \ides{Idea:} Allow more flexibility in changing the IP prefix size
            \ides{Subnet}
                \begin{itemize}
                    \item Internally split one less specific prefix into multiple more specific prefixes
                    \item One prefix is advertised to the internet
                    \item Done by e.g. a company to split different departments
                \end{itemize}
            \ides{Aggregate}
                \begin{itemize}
                    \item Externally join multiple more specific prefixes into one less specific prefix
                    \item One prefix is advertised to the internet
                    \item Done by e.g. ISP
                \end{itemize}
            \item We need to take care to not \textit{hide} some prefixes
            \ipro Reduces the number of prefixes to advertise to the rest of the network
            \ipro Compressed forwarding table
        \end{itemize}
\end{itemize}

\subsubsection{Shorted Path Routing}
\begin{itemize}
    \item Naive approach to find routing between two nodes
    \item Find shortest path by some metric
        \begin{itemize}
            \ides{Latency:} Avoid circuitous paths
            \ides{Bandwidth:} Avoid small pipes
            \ides{Money:} Avoid expensive links
            \ides{Hops:} To reduce switching
            \item Ideal is a combination of all
        \end{itemize}
    \item We ignore workload and only consider topology
        \begin{itemize}
            \item Workload is only considered by sophisticated routing protocols
        \end{itemize}
    \ides{Optimality Property:} Subpaths of shortest paths are also shortest paths
    \ides{Source Tree:} All shortest paths from this source to all nodes
    \ides{Dijkstra's shortest path algorithm}
        \begin{itemize}
            \item Mark all nodes tentative
            \item Set distance from source to $0$ for source
            \item Set distance to $\infty$ for all nodes
            \item While tentative nodes remain:
                \begin{itemize}
                    \item Find node $N$ with lowest distance
                    \item Add link to $N$ to the shortest path
                    \item Potentially relax distances of neighbours of $N$
                \end{itemize}
            \ipro Finds shortest path in order of increasing distances from source
            \item Runtime depends on cost of extracent min-cost node
            \icon Gives complete source tree
                \begin{itemize}
                    \item Not required in internet
                    \item Requires complete topology
                \end{itemize}
        \end{itemize}
    \ides{Equal-Cost Multipath (ECMP)}
        \begin{itemize}
            \item Extension to shortest path routing
            \item Allow multiple shortest paths from node to destination to be used at once
            \item Source tree gets a DAG
            \item Found using modified Dijkstra
            \item Different paths have different latencies
            \item Try to route a flow on the same path
                \begin{itemize}
                    \item Else we get jitter
                \end{itemize}
            \ipro Better reliability
            \ipro Better performance
        \end{itemize}
\end{itemize}

\subsubsection{Intra-Domain Routing}
\begin{itemize}
    \item Routing within an AS
    \item Setting
        \begin{itemize}
            \item Nodes know only the cost to their neighbours
            \item Nodes communicate only with their neighbours
            \item All nodes run the same algorithms
            \item Nodes and links may fail
            \item Messages may be lost
        \end{itemize}
    \item Two main approaches
    \ides{Distance Vector Routing (DV)}
        \begin{itemize}
            \item Solves shortest path problem
            \item Early approach
                \begin{itemize}
                    \item Used by ARPANET and RIP
                    \item Rarely used anymore
                \end{itemize}
            \item Each node maintains a vector of distances to all other nodes
            \item Steps
                \begin{itemize}
                    \item Initialize vector with $0$ cost to self and $\infty$ to all others
                    \item Periodically send vector to neighbours
                    \item Add distance to neighbour to all values heard from that neighbour
                    \item For each vector received, compute the distance to all other nodes by adding the distance to that node to the vector
                    \item Update distance vector by selecting minimal distance for each destination
                \end{itemize}
            \item News travels one hop per exchange
            \item After $n$ exchanges every node know the shortest path of up to $n$ hops
            \ipro Simple
            \ipro Works well
            \ipro Good news travels quickly
            \icon Bad news travels slowly
                \begin{itemize}
                    \item Slow adoption on failures
                \end{itemize}
            \icon \textbf{Count to infinity problem:} After certain nodes becomes unreachable, the other nodes hear from each other that there is still a connection
                \begin{itemize}
                    \item Some solutions exists
                        \begin{itemize}
                            \item Do not work in all conditions
                        \end{itemize}
                    \ides{Split Horizon:} Omit routers learned from neighbours $A$ in updates sent to $A$
                    \ides{Poisoned Reverse:} Set metric $=\infty$ for routers learned from $A$ in updates sent to $A$
                \end{itemize}
            \ides{Routing Information Protocol (RIP)}
                \begin{itemize}
                    \item Introduces in 1988
                    \item DV protocol
                    \item Used hop-count as metric
                    \item Supported networks with longest distance of $15$ hops
                    \item Vector is send out every $30$ sec
                    \item Timeout of $180$ sec to detect failure of nodes
                    \item Included split horizon and poison reverse
                    \item Builds on UDP
                \end{itemize}
        \end{itemize}
    \ides{Link-State Routing (LS)}
    \begin{itemize}
        \item Replaced DV
        \ides{Flooding}
            \begin{itemize}
                \item Required for link-state routing to work
                \item Sends message to every host in the network
                \item Similar to broadcast but less controlled
                \item Each node:
                    \begin{itemize}
                        \item sends incoming message on to all other neighbours
                        \item remembers forwarded messages to prevent resending
                            \begin{itemize}
                                \item Implemented using sequence number
                                \item Each source node has a own sequence number space
                            \end{itemize}
                    \end{itemize}
                \ides{Stop-and-wait}
                    \begin{itemize}
                        \item Makes flooding reliable
                        \item Receiver acknowledges receipt else it is resent
                    \end{itemize}
                \item Each link carries the message at least once
                \ipro Simple
                \icon Inefficient
                    \begin{itemize}
                        \item One node may receive the same message multiple times
                    \end{itemize}
            \end{itemize}
        \item Working
            \begin{itemize}
                \item Two phases
                \item[1)] Modes flood topology in the form of \textbf{link state packets (LSP)}
                    \begin{itemize}
                        \item LSP contains:
                            \begin{itemize}
                                \item Nodes name
                                \item Distances to all adjacent nodes
                                \item Sequence number to identify the flood
                            \end{itemize}

                        \item Each nodes learns full topology by combining all LSPs
                    \end{itemize}
                \item[2)] Each node computes its own forwarding table
                    \begin{itemize}
                        \item Using Dijkstra or equivalent
                        \item All nodes optimize on same metric
                        \item Neighbours agree on shared link's cost
                            \begin{itemize}
                                \item Can by dynamic
                            \end{itemize}
                        \item Link cost should be larger than zero
                    \end{itemize}
                \item Topology changes
                    \begin{itemize}
                        \item Update LSP and flood to network
                        \item Node re-compute routes
                        \item Covers multiple scenarios
                            \begin{itemize}
                                \ides{Link Failure}
                                    \begin{itemize}
                                        \item Both nodes notice and update their LPS
                                            \todo{Is dead node removed or set to infty?}
                                    \end{itemize}
                                \ides{Node failure}
                                    \begin{itemize}
                                        \item Adjacent nodes notice failure of link and update their LPS
                                        \item Failed node got disconnected
                                    \end{itemize}
                                \ides{Adding Link or Node}
                                    \begin{itemize}
                                        \item All adjacent nodes update their LPS
                                        \item Potential new node sends LPS
                                    \end{itemize}
                            \end{itemize}
                    \end{itemize}
            \end{itemize}
        \icon Certain nodes may ignore flooded LSPs due to:
            \begin{itemize}
                \icon Sequence number reach max or gets corrupted
                \icon Node may crash and loose sequence number
                \icon Network partitions and heals again
            \end{itemize}
        \item Can be fixed by including an age on LSP and forget old information
        \icon More computation than DV
        \ipro Better dynamics than DV
        \ides{IS-IS and OSPF}
            \begin{itemize}
                \item LS protocols
                \item Widely used in enterprise
                \ides{Intermediate System to Intermediate System (IS-IS)}
                    \begin{itemize}
                        \item Introduces in 1987
                        \item Very similar to OSPF
                        \item Network can be separated into areas
                    \end{itemize}
                \ides{Open Shortest Path First (OSPF)}
                    \begin{itemize}
                        \item Introduces in 1989
                        \item Loosely based on IS-IS
                        \item Splits AS's network into different areas
                            \begin{itemize}
                                \ipro Scalability
                            \end{itemize}
                        \ides{Internal routers:} Any router inside an area which is \textbf{not} connected to the backbone
                            \begin{itemize}
                                \item Only run the LS algorithm with routers belonging to the same area
                            \end{itemize}
                        \ides{Area border routers:} Any backbone router connecting to an area
                            \begin{itemize}
                                \item Run the LS algorithm for all connected areas
                                \item Condenses topological information of their connected areas and distributes it to the backbone
                            \end{itemize}
                        \ides{Backbone routers:} Any router which is part of the backbone
                        \ides{AS border router:} Any router connected to a different AS
                            \begin{itemize}
                                \item Can be a internal or backbone router
                                \item Advertise external routing information throughout the AS
                            \end{itemize}
                        \item Areas are identified by $32$-bit number
                            \begin{itemize}
                                \item Formatted as IP addresses
                            \end{itemize}
                        \item Areas topology is hidden to other areas
                        \item All networks are exclusively connected via the backbone
                            \begin{itemize}
                                \item Has IP $0.0.0.0$
                            \end{itemize}
                        \item Algorithm
                            \begin{itemize}
                                \item Each router keeps a LS database storing the areas topology
                                \item Routers send LS advertisements (LSA)
                                    \begin{itemize}
                                        \item Send as IP packets
                                        \item Contain originating router ID and its interface with respective cost
                                        \item Area border routers and AS boundary routers distribute additional LSAs containing information of their connected area or AS
                                    \end{itemize}
                                \item LS database in a collection of all LSAs
                                    \begin{itemize}
                                        \item Should be identical for all routers in the same area
                                    \end{itemize}
                            \end{itemize}
                        \ipro Support ECMP
                        \ipro Extensible
                    \end{itemize}
                \ides{IS-IS vs OSPF}\\
\begin{tabular}{| l | l | l |}
    & OSPF & IS-IS\\\hline
    Purpose & Designed for IP traffic & Neutral towards level-3 protocols\\
    Encapsulation & Runs on top of IP & Runs directly on layer 2\\
    Area boundaries & On routers & On links \\
                    & Router belong to mult. area & Router belong to single area\\
    Backbone area & Yes & No\\
    IPv6 support & Yes & Implicitly
\end{tabular}
            \end{itemize}
    \end{itemize}
    \ides{DV vs LS}\\
\begin{tabular}{| l | l | l |}
    Goal & DV & LS\\\hline
    Correctness & Distributed Bellman-Ford & Replicated Dijkstra\\
    Efficient paths & Approx. with shortest paths & Approx. with shortest paths\\
    Fair paths & Approx. with shortest paths & Approx. with shortest paths\\
    Fast convergence & Slow - many exchanges & \textbf{Fast - flood and compute}\\
    Scalability & \textbf{Excellent - storage/computation} & Moderate: storage/computation
\end{tabular}
        \begin{itemize}
            \item Tradeoff between scalability and speed of convergence\\
        \end{itemize}
\end{itemize}
