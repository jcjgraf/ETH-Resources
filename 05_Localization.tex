%! TEX root = ./main.tex

\section{Localization}
\begin{itemize}
    \item Problems:
        \begin{itemize}
            \ides{Position tracking:} Keep track of known location
            \ides{Global localization:} Localize without initial location
            \ides{Kidnapping robot problem:} Robot is moved to new location
        \end{itemize}
    \ides{Map Representation}
        \begin{itemize}
            \item Known a priori or build by robot
            \ides{Types:}
                \begin{itemize*}
                    \item Architecture map
                    \item Finite/infinite set of lines
                    \item Exact cell decomposition
                    \item Fixed cell decomposition
                    \item Topological map
                \end{itemize*}
        \end{itemize}
    \ides{Belief Representation}
        \begin{itemize}
            \item Uncertain due to error $\implies$ probabilistic localization
            \ides{Continuous:}
                \begin{itemize*}
                    \item Precision bound by sensor data
                    \item Typically single hypotheses ($\implies$ danger of getting lost)
                \end{itemize*}
            \ides{Discretized:}
                \begin{itemize*}
                    \item Precision bound by discretization resolution
                    \item Typically multiple hypotheses
                    \item High resource demands
                \end{itemize*}
            \ides{Types}
                \begin{itemize}
                    \item Continuous map with single hypotheses prob. dist. $p(x)$
                    \item Continuous map with multiple hypotheses prob. dist. $p(x)$
                    \item Discretized metric map (grid $k$) with prob. dist. $p(x)$
                    \item Discretized topological map (nodes $n$) with prog. dist. $p(x)$
                \end{itemize}
        \end{itemize}
    \ides{Odometry}
        \begin{itemize}
            \item Process of calculating current position by using previous position and measured motion of last time step
            \ides{Differential Drive Robot:} \todo{Equation Formatting}
\[
    p_t = f(p_{t - 1}, u_t) =
\]
\[
    \begin{pmatrix}
        x_{t - 1}\\
        y_{t - 1}\\
        \theta_{t - 1}
    \end{pmatrix} +
    \begin{pmatrix}
        \frac{\Delta S_r + \Delta S_l}{2} \cos(\theta_{t - 1} + \frac{\Delta S_r - \Delta S_l}{2b})\\
        \frac{\Delta S_r + \Delta S_l}{2} \sin(\theta_{t - 1} + \frac{\Delta S_r - \Delta S_l}{2b})\\
        \frac{\Delta S_r - \Delta S_l}{b}
    \end{pmatrix}
\]
\[
b = \text{Distance between wheels}
\]
            \ides{Error Model:} 
                \begin{itemize}
                    \ides{Error Propagation:} $\Sigma_{p_t} = F_{p_{t-1}} \Sigma_{p_{t-1}} F_{p_{t-1}}^\transpose + F_{\Delta S} \Sigma_{\Delta S} F_{\Delta S}^\transpose$
                    \ides{Error Model:} $\Sigma_{\Delta S} =
                        \begin{pmatrix}
                            k_r |\Delta S_r | & 0\\
                            0 & k_l |\Delta S_l|
                        \end{pmatrix}$
                    \item with $F_{x/y} = \bigtriangledown_{x/y} f$
                \end{itemize}
        \end{itemize}
\end{itemize}

\subsection{Map-Based Localization}
\begin{itemize}
    \item \todo{Add ACT SEE Cycle}
    \item Estimate position using perceived information and a map
    \ides{Terminology:}
        \begin{itemize*}
            \ides{$\mathbf{x_t}$:} robot location at time $t$
            \ides{$\mathbf{u_t}$:} proprioceptive sensor reading at time $t$
            \ides{$\mathbf{z_t}$:} exteroceptive sensor reading (observation) at time $t$
            \ides{$\mathbf{M}$}$= \{m_0, m_1, \dots, m_n\}$ true map of the environment with $n$ features
            \ides{$\mathbf{\text{bel}(x_t)}$}$= p(x_t \mid z_{1 \to t}, u_{1 \to t})$
        \ides{$\mathbf{\overline{\text{bel}}(x_t)}$}$= p(x_t \mid z_{1 \to t - 1}, u_{1 \to t})$
        \end{itemize*}
    \ides{Requirements}
        \begin{itemize}
            \item Initial probability distribution $\text{bel}(x_0)$
            \item Map $M = \{m_0, m_1, \dots, m_n\}$ of the environment
            \item Proprioceptive and exteroceptive data $u_t$ and $z_t$
            \item Probabilistic motion model $p(x_t \mid u_t, M)$
                \begin{itemize}
                    \item Derived from the robots kinematics
                \end{itemize}
            \item Probabilistic measurement model $p(z_t \mid x_t, M)$
                \begin{itemize}
                    \item Derived from the exteroceptive sensor model
                \end{itemize}
        \end{itemize}
    \ides{Steps}
        \begin{itemize}
            \item[0)] Robot is placed somewhere in the environment
            \item[S1)] \textbf{Prediction/Action Update (ACT):} Move and estimate position using proprioceptive sensors
                \begin{itemize}
                    \item Uncertainty grows
                \end{itemize}
            \item[S2)] \textbf{Perception/Measurement Update (SEE):} Make observation using exteroceptive sensors
                \begin{itemize}
                    \item Uncertainty shrinks
                \end{itemize}
        \end{itemize}
\end{itemize}

\subsubsection{Markov Localization}
\begin{itemize}
    \ides{Solves:}
        \begin{itemize*}
            \item Global localization
            \item Position tracking
            \item Kidnapped robot
        \end{itemize*}
    \item Discretized pose representation $x_t$
    \item $\text{bel}(x_t)$ is representation by arbitrary prob. density function
        \begin{itemize}
            \item Multiple hypotheses
        \end{itemize}
    \ides{Markov Assumption:} $\text{bel}(x_t) = p(x_t \mid x_0, u_{0 \to t}, z_{0 \to t}) = p(x_t \mid x_{t - 1}, u_t, z_t)$
    \ides{Steps:} Repeat for all $x_t$ \todo{Write as algorithm}
        \begin{itemize}
            \item[S1)] \textbf{ACT:} $\overline{\text{bel}}(x_t) = \sum_{x_{t-1}} p(x_t \mid u_t, x_{t - 1}) \text{bel}(x_{t-1})$
            \item[S2)] \textbf{SEE:} $\text{bel}(x_t) = \eta p(z_t \mid x_t, M) \overline{\text{bel}}(x_t)$
                \begin{itemize}
                    \item $\eta = \frac{1}{p(y)}$
                \end{itemize}
        \end{itemize}
    \icon Huge state space
    \icon Inefficient
    \ides{Improvements:}
        \begin{itemize*}
            \item Change of cell size
            \item Adaptive cell size
            \ides{Randomized Sampling:} Approximation of belief state by a representative subset of possible locations. Higher density around peak points
        \end{itemize*}
\end{itemize}

\subsubsection{Extended Kalman Filter (EKF) Localization}
\begin{itemize}
    \ides{Solves:}
        \begin{itemize*}
            \item Position tracking
        \end{itemize*}
    \item $\text{bel}(x_t)$, motion model and measurement model is represented by a normal distribution
        \begin{itemize}
            \item Single hypotheses
        \end{itemize}
    \ides{Steps:}
        \begin{itemize}
            \item[S1)] \textbf{Prediction Update}
                \begin{itemize}
                    \item New position: $\hat x_t = f(x_{t-1}, u_t)$
                    \item Position uncertainty: $\hat P_t = F_x P_{t-1} F_x^\transpose + F_u Q_t F_u^\transpose$
                    \item
                        \begin{itemize*}
                            \ides{$\mathbf{P_{t - 1}}$:} Covariance of the previous state $x - 1$
                            \ides{$\mathbf{Q_t}$:} Covariance of motion model noise
                            \ides{$\mathbf{F_{x/u}}$:} Jacobian w.r.t. $x/u$
                        \end{itemize*}
                \end{itemize}
            \item[S2)] \textbf{Measurement Update}
                \begin{itemize}
                    \item[1)] \textbf{Observation:} Obtain set of observation $z_t^i$ with covariance $R_t^i, i=1 \dots n$
                    \item[2)] \textbf{Measurement Prediction:} Predict feature observations $\hat z_t^j = h^j(\hat x_t, m^j)$ and compute its Jacobian $H^j$ w.r.t $\hat x_t$

                    \item[3)] \textbf{Matching:}
                        \begin{itemize}
                            \item Compute the innovation $v_t^{ij} = [z_t^i - \hat z_t^j]$
                            \item Compute the innovation covariance $\Sigma_{IN_t}^{ij} = H^j \hat P_t {H^j}^\transpose + R_t^i$
                            \item Find matches with a validation gate $g$
                                \begin{itemize}
                                    \item Mahalanobis distance: ${v_t^{ij}}^\transpose (\Sigma_{IN_t}^{ij})^{-1} v_t^{ij} \le g^2$
                                \end{itemize}
                        \end{itemize}
                    \item[4)] \textbf{Estimation:}
                        \begin{itemize}
                            \item Stack validated observations into $z_t$, corresponding innovations into $v_t$, measurement Jacobians into $H_t$ and $R_t = \mathrm{diag}(R_t^i)$
                            \item Compute composite innovation covariance $\Sigma_{IN_t}$
                            \item For each match, update position estimate $x_t = \hat x_t + K_t v_t$
                            \item For each match, update covariance $P_t = \hat P_t - K_t \Sigma_{IN_t}K_t^\transpose$
                                \begin{itemize}
                                    \ides{Kalman Gain:} $K_t = \hat P_t H_t^\transpose (\Sigma_{IN_t})^{-1}$
                                \end{itemize}
                        \end{itemize}
                \end{itemize}
        \end{itemize}
    \ipro Precise
    \ipro Efficient
    \icon Robot may get lost
\end{itemize}
